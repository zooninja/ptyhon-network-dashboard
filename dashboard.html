<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Network Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a192f 0%, #112240 50%, #1a365d 100%);
            min-height: 100vh;
            color: #e6f1ff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(17, 34, 64, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(100, 255, 218, 0.1);
        }

        h1 {
            font-size: 2.5em;
            color: #64ffda;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(100, 255, 218, 0.3);
        }

        .subtitle {
            color: #8892b0;
            font-size: 1.1em;
        }

        .system-info {
            color: #64ffda;
            font-size: 0.9em;
            margin-top: 10px;
            opacity: 0.8;
        }

        .system-info span {
            margin: 0 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(17, 34, 64, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(100, 255, 218, 0.2);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(100, 255, 218, 0.2);
        }

        .stat-card.active {
            border: 2px solid #64ffda;
            background: rgba(100, 255, 218, 0.15);
            box-shadow: 0 10px 30px rgba(100, 255, 218, 0.3);
        }

        .stat-label {
            color: #8892b0;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            color: #64ffda;
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(100, 255, 218, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(17, 34, 64, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(100, 255, 218, 0.2);
        }

        .section-title {
            color: #64ffda;
            font-size: 1.5em;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(100, 255, 218, 0.3);
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(100, 255, 218, 0.1);
            color: #ccd6f6;
        }

        tr:hover {
            background: rgba(100, 255, 218, 0.05);
            cursor: pointer;
        }

        .port {
            color: #f76d82;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .process-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            display: inline-block;
        }

        .top-process {
            background: rgba(100, 255, 218, 0.05);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #64ffda;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease, background 0.3s ease, border-left 0.3s ease;
            cursor: pointer;
        }

        .top-process:hover {
            transform: translateX(5px);
            background: rgba(100, 255, 218, 0.1);
        }

        .top-process.active {
            background: rgba(100, 255, 218, 0.2);
            border-left: 5px solid #64ffda;
            box-shadow: 0 5px 20px rgba(100, 255, 218, 0.2);
        }

        .process-info {
            flex: 1;
        }

        .process-name {
            color: #64ffda;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .process-pid {
            color: #8892b0;
            font-size: 0.85em;
        }

        .connection-count {
            background: linear-gradient(135deg, #f76d82 0%, #d63447 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2em;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content {
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid #64ffda;
            border-radius: 15px;
            width: 80%;
            max-width: 700px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        .close {
            color: #8892b0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #f76d82;
        }

        .modal-header {
            color: #64ffda;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(100, 255, 218, 0.3);
            padding-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(100, 255, 218, 0.05);
            border-radius: 8px;
            border-left: 3px solid #64ffda;
        }

        .detail-label {
            color: #8892b0;
            font-weight: 600;
        }

        .detail-value {
            color: #e6f1ff;
            font-family: 'Courier New', monospace;
        }

        .kill-button {
            background: linear-gradient(135deg, #f76d82 0%, #d63447 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kill-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(247, 109, 130, 0.4);
        }

        .close-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            margin-left: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .close-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .warning {
            background: rgba(247, 109, 130, 0.1);
            border: 1px solid #f76d82;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #f76d82;
        }

        .loading {
            text-align: center;
            color: #64ffda;
            font-size: 1.2em;
            padding: 20px;
        }

        .filter-bar {
            background: rgba(17, 34, 64, 0.6);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(100, 255, 218, 0.2);
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-bar.active {
            display: flex;
        }

        .filter-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            animation: slideIn 0.3s ease;
        }

        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            transition: transform 0.2s ease;
        }

        .filter-tag .remove:hover {
            transform: scale(1.3);
            color: #f76d82;
        }

        .clear-filters-btn {
            background: linear-gradient(135deg, #f76d82 0%, #d63447 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .clear-filters-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(247, 109, 130, 0.4);
        }

        .ninja {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 2.5em;
            opacity: 0.6;
            transition: opacity 0.3s ease, transform 0.3s ease;
            cursor: pointer;
            z-index: 999;
            filter: drop-shadow(0 0 10px rgba(100, 255, 218, 0.5));
        }

        .ninja:hover {
            opacity: 1;
            transform: scale(1.3) rotate(15deg);
            filter: drop-shadow(0 0 20px rgba(100, 255, 218, 0.8));
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Python Network Dashboard</h1>
            <div class="subtitle">Real-time Network Connection Monitor | Auto-refresh: 5s</div>
            <div class="system-info" id="system-info">Loading...</div>
        </header>

        <div class="stats-grid">
            <div class="stat-card" data-filter-state="ALL" onclick="filterByState('ALL')">
                <div class="stat-label">Total</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card" data-filter-state="ESTABLISHED" onclick="filterByState('ESTABLISHED')">
                <div class="stat-label">Established</div>
                <div class="stat-value" id="stat-established">0</div>
            </div>
            <div class="stat-card" data-filter-state="LISTEN" onclick="filterByState('LISTEN')">
                <div class="stat-label">Listening</div>
                <div class="stat-value" id="stat-listening">0</div>
            </div>
            <div class="stat-card" data-filter-state="TIME_WAIT" onclick="filterByState('TIME_WAIT')">
                <div class="stat-label">Time Wait</div>
                <div class="stat-value" id="stat-timewait">0</div>
            </div>
            <div class="stat-card" data-filter-state="CLOSE_WAIT" onclick="filterByState('CLOSE_WAIT')">
                <div class="stat-label">Close Wait</div>
                <div class="stat-value" id="stat-closewait">0</div>
            </div>
        </div>

        <div class="filter-bar" id="filter-bar">
            <div id="filter-tags"></div>
            <button class="clear-filters-btn" onclick="clearAllFilters()">Clear All Filters</button>
        </div>

        <div class="main-content">
            <div class="section">
                <h2 class="section-title">Active Connections</h2>
                <div id="connections-table">
                    <div class="loading">Loading connections...</div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Top Processes</h2>
                <div id="top-processes">
                    <div class="loading">Loading processes...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="ninja" title="Network Ninja">&#x1F977;</div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-header">Connection Details</h2>
            <div id="modal-body">
                <div class="loading">Loading details...</div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;
        const modal = document.getElementById('detailModal');
        const closeBtn = document.querySelector('.close');

        // Filter state
        let activeFilters = {
            state: null,
            processName: null
        };

        // Store all connections for filtering
        let allConnections = [];

        // Close modal handlers
        closeBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                modal.style.display = 'none';
            }
        });

        async function fetchSystemInfo() {
            try {
                const response = await fetch('/api/system');
                const data = await response.json();
                document.getElementById('system-info').innerHTML = `<span>${data.hostname}</span><span>|</span><span>${data.ip}</span>`;
            } catch (error) {
                console.error('Error fetching system info:', error);
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                // Update stats
                document.getElementById('stat-total').textContent = data.Stats.Total;
                document.getElementById('stat-established').textContent = data.Stats.Established;
                document.getElementById('stat-listening').textContent = data.Stats.Listening;
                document.getElementById('stat-timewait').textContent = data.Stats.TimeWait;
                document.getElementById('stat-closewait').textContent = data.Stats.CloseWait;

                // Update top processes
                const topProcessesHtml = data.TopProcesses.map(proc => `
                    <div class="top-process ${activeFilters.processName === proc.ProcessName ? 'active' : ''}"
                         onclick="filterByProcess('${proc.ProcessName}')">
                        <div class="process-info">
                            <div class="process-name">${proc.ProcessName}</div>
                            <div class="process-pid">PID: ${proc.ProcessId}</div>
                        </div>
                        <div class="connection-count">${proc.ConnectionCount}</div>
                    </div>
                `).join('');

                document.getElementById('top-processes').innerHTML = topProcessesHtml || '<div class="loading">No active processes</div>';
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function fetchConnections() {
            try {
                const response = await fetch('/api/connections');
                allConnections = await response.json();

                // Apply filters
                displayConnections();
            } catch (error) {
                console.error('Error fetching connections:', error);
                document.getElementById('connections-table').innerHTML = '<div class="loading">Error loading connections</div>';
            }
        }

        function displayConnections() {
            let filteredConnections = [...allConnections];

            // Filter by state
            if (activeFilters.state && activeFilters.state !== 'ALL') {
                filteredConnections = filteredConnections.filter(conn => conn.State === activeFilters.state);
            }

            // Filter by process name
            if (activeFilters.processName) {
                filteredConnections = filteredConnections.filter(conn => conn.ProcessName === activeFilters.processName);
            }

            if (filteredConnections.length === 0) {
                document.getElementById('connections-table').innerHTML = '<div class="loading">No connections match the current filters</div>';
                return;
            }

            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Local Port</th>
                            <th>Remote Address</th>
                            <th>Remote Port</th>
                            <th>State</th>
                            <th>Process</th>
                            <th>PID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredConnections.map(conn => `
                            <tr onclick="showDetails(${conn.LocalPort}, ${conn.RemotePort})">
                                <td><span class="port">${conn.LocalPort}</span></td>
                                <td>${conn.RemoteAddress}</td>
                                <td><span class="port">${conn.RemotePort}</span></td>
                                <td>${conn.State}</td>
                                <td><span class="process-badge">${conn.ProcessName}</span></td>
                                <td>${conn.ProcessId}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('connections-table').innerHTML = tableHtml;
        }

        async function showDetails(localPort, remotePort) {
            modal.style.display = 'block';
            document.getElementById('modal-body').innerHTML = '<div class="loading">Loading details...</div>';

            try {
                const response = await fetch(`/api/connection/${localPort}/${remotePort}`);
                const details = await response.json();

                if (response.ok) {
                    const detailsHtml = `
                        <div class="detail-row">
                            <span class="detail-label">Process Name:</span>
                            <span class="detail-value">${details.ProcessName}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Process ID:</span>
                            <span class="detail-value">${details.ProcessId}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Process Path:</span>
                            <span class="detail-value">${details.ProcessPath}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">CPU Usage:</span>
                            <span class="detail-value">${details.ProcessCPU}%</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Memory Usage:</span>
                            <span class="detail-value">${details.ProcessMemory} MB</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Thread Count:</span>
                            <span class="detail-value">${details.ProcessThreads}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Start Time:</span>
                            <span class="detail-value">${details.ProcessStartTime}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Local Port:</span>
                            <span class="detail-value port">${details.LocalPort}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Remote Address:</span>
                            <span class="detail-value">${details.RemoteAddress}:${details.RemotePort}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Connection State:</span>
                            <span class="detail-value">${details.State}</span>
                        </div>
                        <div class="warning">
                            <strong>Warning:</strong> Terminating this process will close the connection and may cause data loss. This action cannot be undone.
                        </div>
                        <button class="kill-button" onclick="killProcess(${localPort}, ${remotePort}, '${details.ProcessName}', ${details.ProcessId})">
                            Terminate Process
                        </button>
                        <button class="close-button" onclick="modal.style.display='none'">
                            Close
                        </button>
                    `;

                    document.getElementById('modal-body').innerHTML = detailsHtml;
                } else {
                    document.getElementById('modal-body').innerHTML = `<div class="loading">Error: ${details.error}</div>`;
                }
            } catch (error) {
                console.error('Error fetching details:', error);
                document.getElementById('modal-body').innerHTML = '<div class="loading">Error loading details</div>';
            }
        }

        async function killProcess(localPort, remotePort, processName, processId) {
            const confirmed = confirm(
                `Are you sure you want to terminate this process?\n\n` +
                `Process: ${processName}\n` +
                `PID: ${processId}\n\n` +
                `This will close all connections for this process and cannot be undone.`
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/connection/${localPort}/${remotePort}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Success: ${result.message}\n\nProcess: ${result.processName}\nPID: ${result.processId}`);
                    modal.style.display = 'none';
                    // Refresh data
                    fetchConnections();
                    fetchStats();
                } else {
                    alert(`Failed to terminate process:\n\n${result.message}`);
                }
            } catch (error) {
                console.error('Error killing process:', error);
                alert('Error: Failed to communicate with server');
            }
        }

        function filterByState(state) {
            // Toggle filter if clicking the same state
            if (activeFilters.state === state) {
                activeFilters.state = null;
            } else {
                activeFilters.state = state === 'ALL' ? null : state;
            }

            updateFilterUI();
            displayConnections();
        }

        function filterByProcess(processName) {
            // Toggle filter if clicking the same process
            if (activeFilters.processName === processName) {
                activeFilters.processName = null;
            } else {
                activeFilters.processName = processName;
            }

            updateFilterUI();
            displayConnections();
        }

        function removeFilter(filterType) {
            activeFilters[filterType] = null;
            updateFilterUI();
            displayConnections();
        }

        function clearAllFilters() {
            activeFilters.state = null;
            activeFilters.processName = null;
            updateFilterUI();
            displayConnections();
        }

        function updateFilterUI() {
            // Update stat card active states
            document.querySelectorAll('.stat-card').forEach(card => {
                const cardState = card.getAttribute('data-filter-state');
                if (activeFilters.state === cardState || (activeFilters.state === null && cardState === 'ALL')) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });

            // Update filter bar
            const filterBar = document.getElementById('filter-bar');
            const filterTags = document.getElementById('filter-tags');
            let tagsHtml = '';

            if (activeFilters.state) {
                const stateName = activeFilters.state.replace('_', ' ').toLowerCase()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                tagsHtml += `
                    <div class="filter-tag">
                        <span>State: ${stateName}</span>
                        <span class="remove" onclick="removeFilter('state')">&times;</span>
                    </div>
                `;
            }

            if (activeFilters.processName) {
                tagsHtml += `
                    <div class="filter-tag">
                        <span>Process: ${activeFilters.processName}</span>
                        <span class="remove" onclick="removeFilter('processName')">&times;</span>
                    </div>
                `;
            }

            filterTags.innerHTML = tagsHtml;

            // Show/hide filter bar
            if (activeFilters.state || activeFilters.processName) {
                filterBar.classList.add('active');
            } else {
                filterBar.classList.remove('active');
            }
        }

        function refresh() {
            fetchConnections();
            fetchStats();
        }

        // Initial load
        fetchSystemInfo();
        refresh();

        // Auto-refresh every 5 seconds
        refreshInterval = setInterval(refresh, 5000);
    </script>
</body>
</html>
